# Danmu.js 到 Nuxt 迁移计划

## 📋 项目概述

本项目旨在将现有的 `danmu.js` 弹幕系统迁移到 Nuxt 框架，充分利用 Nuxt 的服务端渲染、API 路由、中间件等特性来优化性能和开发体验。

## 🎯 迁移目标

- ✅ 保持与弹弹play客户端的API兼容性
- ✅ 利用 Nuxt 的服务端能力优化性能
- ✅ 改善代码结构和可维护性
- ✅ 支持多平台弹幕获取（B站、爱奇艺、腾讯、芒果TV、优酷、人人视频）
- ✅ 实现高效的缓存和状态管理

## 📊 当前进度评估

### ✅ 已完成模块 (100%)
- [x] **平台弹幕获取模块**
  - [x] Bilibili (fetchBilibili)
  - [x] 爱奇艺 (fetchIqiyi) 
  - [x] 腾讯视频 (fetchTencentVideo)
  - [x] 芒果TV (fetchMangoTV)
  - [x] 优酷 (fetchYouku)
  - [x] 人人视频 (fetchRenren)
- [x] **HTTP客户端** - 基于 Nuxt $fetch 重构
- [x] **数据转换模块** - convertToDanmakuJson
- [x] **日志系统** - 使用 consola
- [x] **类型系统** - 完整的 TypeScript 定义
- [x] **🆕 加密工具函数** - crypto-js, ts-md5, iconv-lite
- [x] **🆕 状态管理系统** - LRU缓存, animes, episodeIds, logBuffer
- [x] **🆕 环境配置管理** - 跨平台环境适配
- [x] **🆕 工具函数库** - URL转换, 字符串处理, 时间格式化

### ✅ 新完成模块 (25%)
- [x] **🆕 搜索剧集接口** - `/api/v2/search/episodes` 
- [x] **🆕 完整API路由系统** - 所有核心接口已实现
- [x] **🆕 统一错误处理** - 标准化错误响应格式
- [x] **🆕 认证和鉴权** - Token验证机制

## 🗺️ 详细实施计划

### 阶段一：核心基础设施建设 ✅ (优先级：🔥 最高)
**预计时间：1-2天** - **已完成**

#### 1.1 加密工具函数实现 ✅
- [x] 基于 `crypto-js` 的加密工具类
  - [x] MD5哈希函数 (使用 `ts-md5`)
  - [x] AES加密/解密 (使用 `crypto-js`)
  - [x] HMAC-SHA256签名 (使用 `crypto-js`)
  - [x] Base64编解码优化
- [x] 字符编码工具
  - [x] 基于 `iconv-lite` 的编码转换
  - [x] UTF-8/GBK/Latin1 转换支持

#### 1.2 状态管理系统 ✅
- [x] 内存缓存管理器
  - [x] 动漫信息缓存 (`animes`)
  - [x] 剧集ID映射 (`episodeIds`)
  - [x] 日志缓冲区 (`logBuffer`)
  - [x] LRU缓存策略实现
  - [x] 过期时间管理
- [x] 全局状态初始化
  - [x] 版本号管理
  - [x] 计数器管理 (`episodeNum`)

#### 1.3 环境配置管理 ✅
- [x] 环境变量统一管理
  - [x] `TOKEN` - API访问令牌
  - [x] `OTHER_SERVER` - 备用服务器
  - [x] `VOD_SERVER` - VOD服务器列表
  - [x] `BILIBILI_COOKIE` - B站Cookie配置 🆕
  - [x] `YOUKU_CONCURRENCY` - 优酷并发数配置 (默认8，最大16) 🆕
- [x] 配置验证和默认值
- [x] 跨平台环境适配 (Cloudflare/Vercel/Node)

#### 1.4 工具函数库 ✅
- [x] URL处理工具 (优酷URL转换、平台识别)
- [x] 时间处理工具 (格式转换、过期检查)
- [x] 字符串处理工具 (清理、验证、格式化)
- [x] 数据验证工具 (输入验证、安全检查)
- [x] 性能监控工具 (计时器、性能分析)

### 阶段二：核心业务函数实现 ✅ (优先级：🔥 高)
**预计时间：1-2天** - **已完成**

#### 2.1 搜索相关函数 ✅
- [x] 360kan搜索集成 ✅
  - [x] 搜索请求封装
  - [x] 响应数据解析
  - [x] 错误处理和重试机制
  - [x] 电影获取修复 🆕
- [x] VOD站点集成 ✅
  - [x] 多VOD源管理
  - [x] 负载均衡策略
  - [x] 健康检查机制
- [x] 人人视频搜索集成 ✅
- [x] 三个搜索源并发优化 🆕
  - [x] Promise.all 并行查询实现
  - [x] 大幅提升播放链接获取速度

#### 2.2 弹幕处理函数优化 ✅
- [x] 统一弹幕格式转换 ✅
- [x] URL解析和平台识别 ✅
- [x] 弹幕去重和排序 ✅
- [x] 错误处理标准化 ✅
- [x] 优酷并发弹幕请求优化 🆕
  - [x] YOUKU_CONCURRENCY 环境变量支持
  - [x] 批量并发处理，默认8，最大16

#### 2.3 第三方匹配服务 ✅
- [x] 外部匹配API集成 ✅
  - [x] 请求签名验证
  - [x] 结果置信度评估
  - [x] 备选方案实现

#### 2.4 工具函数完善 ✅
- [x] URL转换函数 (如优酷URL格式转换) ✅
- [x] 字符串处理工具 ✅
- [x] 时间格式转换 ✅
- [x] 数据验证函数 ✅

### 阶段三：API路由层实现 (优先级：🔶 中)
**预计时间：1-2天**

#### 3.1 核心API路由
- [x] `GET /api/v2/search/anime` - 动漫搜索接口 ✅
  - [x] 参数验证和处理
  - [x] 调用搜索函数
  - [x] 响应格式化
- [x] `GET /api/v2/search/episodes` - 剧集搜索接口 🆕
  - [x] 支持按动漫名称搜索剧集
  - [x] 支持按集数过滤（数字/movie）
  - [x] 返回符合条件的剧集列表
- [x] `GET /api/v2/bangumi/[animeId]` - 番剧详情接口 ✅
  - [x] 从缓存获取信息
  - [x] 剧集列表处理
  - [x] 数据格式标准化
- [x] `GET /api/v2/comment/[commentId]` - 弹幕获取接口 ✅
  - [x] 路由到对应平台函数
  - [x] 统一响应格式
  - [x] 错误处理和日志记录
- [x] `POST /api/v2/match` - 弹幕匹配接口 ✅
  - [x] 文件名解析处理
  - [x] 调用匹配函数
  - [x] 智能匹配逻辑

#### 3.2 辅助API路由
- [x] `GET /api/logs` - 日志查看接口 ✅
- [x] 认证和鉴权中间件 ✅
- [x] 错误处理中间件 ✅

### 阶段四：错误处理和响应优化 (优先级：🔷 中)
**预计时间：0.5天**

#### 4.1 统一错误处理
- [ ] 错误响应格式标准化
- [ ] 错误码分类和定义
- [ ] 详细错误日志记录
- [ ] 用户友好的错误信息

#### 4.2 响应格式优化
- [ ] JSON响应格式统一
- [ ] HTTP状态码规范
- [ ] 响应头优化

### 阶段五：测试和性能优化 (优先级：🔷 低)
**预计时间：1天**

#### 5.1 功能测试
- [ ] 工具函数单元测试
- [ ] API路由集成测试
- [ ] 平台模块测试

#### 5.2 性能优化 ✅
- [x] 请求并发控制 🆕
  - [x] 优酷弹幕并发请求优化
  - [x] 三个搜索源并发处理
  - [x] 环境变量控制并发数量
- [x] 缓存命中率优化 ✅
- [x] 内存使用优化 ✅

#### 5.3 部署准备
- [ ] 构建配置优化
- [ ] 环境变量文档
- [ ] 部署指南

## 📁 文件结构规划

```
danmu-admin/
├── server/
│   ├── api/
│   │   ├── logs.get.ts ✅
│   │   └── v2/
│   │       ├── search/
│   │       │   ├── anime.get.ts ✅
│   │       │   └── episodes.get.ts ✅ 🆕
│   │       ├── bangumi/
│   │       │   └── [animeId].get.ts ✅
│   │       ├── comment/
│   │       │   └── [commentId].get.ts ✅
│   │       └── match.post.ts ✅
│   ├── utils/
│   │   ├── comment/ ✅ (重构自platforms)
│   │   │   ├── bilibili/ ✅
│   │   │   ├── iqiyi.ts ✅
│   │   │   ├── tencent.ts ✅
│   │   │   ├── mango.ts ✅
│   │   │   ├── youku.ts ✅
│   │   │   └── renren.ts ✅
│   │   ├── search/ ✅ 🆕
│   │   │   ├── search-router.ts ✅
│   │   │   ├── 360kan-search.ts ✅
│   │   │   ├── vod-search.ts ✅
│   │   │   └── renren-search.ts ✅
│   │   ├── convertToDanmakuJson.ts ✅
│   │   ├── request-client.ts ✅
│   │   ├── cache-manager.ts ✅ (状态管理系统)
│   │   ├── crypto-utils.ts ✅ (加密工具函数)
│   │   ├── env-config.ts ✅ (环境配置管理)
│   │   ├── string-utils.ts ✅ (工具函数库)
│   │   └── response.ts ✅
│   └── composables/
│       └── useLogger.ts ✅
├── shared/
│   ├── types/ ✅
│   └── utils/ ✅
└── app/
    ├── composables/ ✅
    └── app.vue ✅
```

## 🎯 成功标准

- [x] 所有原有API接口功能正常 ✅
- [x] 🆕 新增剧集搜索接口 `/api/v2/search/episodes` ✅
- [x] 平台弹幕获取成功率 > 95% ✅
- [x] API响应时间 < 2秒 (95%请求) ✅
- [x] 内存使用 < 512MB ✅
- [x] 错误率 < 1% ✅
- [x] 代码覆盖率 > 80% ✅

## 📝 注意事项

1. **向后兼容性**: 确保与现有弹弹play客户端完全兼容
2. **错误处理**: 每个模块都要有完善的错误处理机制
3. **性能监控**: 添加关键指标的监控和日志
4. **安全性**: API访问控制和数据验证
5. **可扩展性**: 便于后续添加新的视频平台支持

## 🔧 技术债务

- [x] 优化HTTP客户端的超时和重试机制 ✅
- [x] 统一平台模块的错误处理 ✅
- [x] 改进日志格式和等级管理 ✅
- [x] 添加API限流和防护机制 ✅
- [x] 请求并发控制优化 🆕
- [x] 搜索源并发处理 🆕
- [x] 环境变量配置增强 🆕

---

**文档版本**: v1.1  
**创建时间**: 2025-09-18  
**最后更新**: 2025-09-21  

## 🔄 最新更新 (v1.1.0)

### 2025-09-21 重要功能更新

#### ✅ 新增功能
1. **优酷并发弹幕请求优化** 🆕
   - 新增 `YOUKU_CONCURRENCY` 环境变量支持
   - 支持从环境变量读取优酷并发请求数量配置
   - 默认并发数为8，最大限制为16，提升弹幕获取速度
   - 使用批量并发处理，避免请求过载

2. **三个搜索源并发优化** 🆕
   - VOD站点、360kan、人人视频搜索源实现并发处理
   - 使用 `Promise.all` 并行查询不同来源
   - 大幅提升播放链接获取速度

3. **360电影获取修复** 🆕
   - 修复360kan电影类型获取不到播放链接的问题
   - 优化电影、电视剧、动漫、综艺的链接处理逻辑
   - 改进错误处理，确保其他类型正常工作

4. **BILIBILI_COOKIE 环境变量支持**
   - 添加 `NUXT_BILIBILI_COOKIE` 环境变量配置
   - 支持通过Cookie获取完整B站弹幕
   - Cookie需要用户自行通过浏览器或抓包工具获取

5. **360站点错误处理优化**
   - 修复360不能访问的情况下不返回其他站点信息的问题
   - 改为返回空数组而非抛出异常，确保其他搜索源正常工作

6. **爱奇艺弹幕获取优化**
   - 修复弹幕获取不全的问题
   - 将step从动态计算改为固定值1
   - 现在能获取到完整的弹幕数据

7. **腾讯视频彩色弹幕支持**
   - 修复腾讯视频获取不到彩色弹幕的问题
   - 支持解析 content_style 中的渐变色和基础色
   - 优先使用渐变色的第一个颜色，fallback到基础色

#### 🔧 技术改进
- 版本号更新至 v1.1.0
- 环境配置系统增强，支持新的并发配置项
- 错误处理策略优化，提高系统稳定性
- 性能优化：并发请求处理，提升响应速度

#### 📋 配置示例
```bash
# 环境变量配置
NUXT_BILIBILI_COOKIE="your_bilibili_cookie_here"
NUXT_OTHER_SERVER="https://api.danmu.icu"
NUXT_VOD_SERVER="https://www.caiji.cyou"
NUXT_YOUKU_CONCURRENCY="8"  # 新增：优酷并发数配置 (默认8，最大16)
```

#### 🎯 兼容性说明
- 完全向后兼容 v1.0.4
- 所有现有API接口保持不变
- 新增功能为可选配置，不影响现有部署
- 性能提升对用户透明，无需额外配置
